<!-- booking/templates/booking/store_timetable.html -->
{% extends 'booking/base.html' %}
{% load booking_extras %}

{% block title %}预约时间表 - {{ store.name }}{% endblock %}

{% block content %}
<style>
    /* 容器样式 */
    .schedule-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 10px;
        box-sizing: border-box;
    }
    .timetable-wrapper {
        position: relative;
        overflow-x: auto; /* 允许横向滚动 */
        margin-top: 20px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 12px;
        max-height: calc(100vh - 200px); /* 桌面端限制高度，允许纵向滚动 */
        overflow-y: auto;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .timetable {
        width: 100%;
        min-width: 800px; /* 保证最小宽度，防止列太窄 */
        border-collapse: collapse;
        table-layout: fixed; /* 固定列宽 */
    }

    /* 表头样式 */
    .timetable thead th {
        background-color: #f8f9fa;
        padding: 15px 5px;
        border-bottom: 2px solid #ddd;
        border-right: 1px solid #eee;
        position: sticky;
        top: 0;
        z-index: 20; /* 确保表头在滚动时保持在最前面 */
        text-align: center;
    }

    /* 第一列（时间轴）样式 */
    .time-col {
        width: 80px;
        text-align: center;
        background-color: #fafafa;
        border-right: 2px solid #ddd;
        color: #666;
        font-size: 0.9em;
        vertical-align: top;
        padding: 0;
        position: sticky; /* 时间轴列在横向滚动时固定 */
        left: 0;
        z-index: 15;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); /* 阴影增加层次感 */
    }

    /* 时间刻度线 */
    .time-slot-marker {
        height: 60px; /* ★★★ 核心高度：1小时=60px, 1分钟=1px ★★★ */
        border-bottom: 1px solid #eee; /* 小时分割线 */
        box-sizing: border-box;
        position: relative;
        display: flex; /* 让时间文字居中 */
        align-items: center;
        justify-content: center;
    }

    .time-label {
        position: absolute;
        top: -10px; /* 把时间文字往上提，对齐刻度线 */
        background: #fafafa; /* 背景色覆盖线条 */
        padding: 0 5px;
        z-index: 16;
        font-weight: bold;
    }

    /* 桌子列样式 */
    .table-col-content {
        position: relative; /* 作为预约块的定位基准 */
        height: 1440px; /* 24小时 * 60px/小时 = 1440px */
        background-image: linear-gradient(to bottom, #eee 1px, transparent 1px);
        background-size: 100% 60px; /* 画出小时辅助线 */
    }

    /* 预约块样式 */
    .booking-block {
        position: absolute;
        left: 5%;
        width: 90%; /* 留一点边距 */
        background-color: #d1e7dd;
        border: 1px solid #a3cfbb;
        border-radius: 4px;
        color: #0f5132;
        font-size: 0.8em;
        padding: 4px;
        box-sizing: border-box;
        overflow: hidden;
        z-index: 1;
        box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: transform 0.1s, z-index 0.1s;
    }

    .booking-block:hover {
        z-index: 100 !important; /* 悬停时置顶 */
        transform: scale(1.02);
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* 当前时间线 */
    #current-time-line {
        position: absolute;
        left: 80px; /* 偏移掉时间列的宽度 */
        right: 0;
        border-top: 2px dashed red;
        z-index: 50; /* 确保在预约块之上 */
        pointer-events: none; /* 不会阻挡鼠标事件 */
    }

    .timetable-mobile {
        display: none;
        margin-top: 20px;
    }
    .mobile-table-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 12px;
        background: #fff;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .mobile-table-head {
        font-weight: 600;
        margin-bottom: 6px;
        color: #333;
    }
    .mobile-booking {
        padding: 8px 10px;
        border: 1px dashed #cbd5f5;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 0.9em;
        background: #f8fafc;
    }
    .mobile-booking:last-child { margin-bottom: 0; }
    .mobile-booking strong { display: block; color: #111; margin-bottom: 4px; }
    .no-booking { color: #777; font-size: 0.9em; }

    @media (max-width: 900px) {
        .timetable-wrapper {
            max-height: none;
        }
    }
    @media (max-width: 680px) {
        .timetable-wrapper {
            display: none;
        }
        .timetable-mobile {
            display: block;
        }
    }
</style>

<div class="schedule-container">
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; align-items: center;">
        <h1 style="margin:0;">{{ store.name }} 24小时预约表</h1>
        <div style="font-size: 0.9em; color: #666; text-align: right;">
            当前展示范围: {{ timetable_start_datetime|date:"Y-m-d H:i" }} 开始的未来24小时<br>
            <a href="{% url 'store_status' %}" style="text-decoration: none; display:inline-block; margin-top:4px;">&larr; 返回列表</a>
            <a href="{% url 'create_booking' store.id %}" style="background-color: #007bff; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; margin-left: 10px; display:inline-block;">+ 发起预约</a>
        </div>
    </div>
    
    <p style="color: #666; font-size: 0.9em; margin-top:10px;">
        <span style="display: inline-block; width: 12px; height: 12px; background: #d1e7dd; border: 1px solid #a3cfbb; margin-right: 5px; vertical-align: middle;"></span>
        已分配桌位的预约
    </p>

    <div class="timetable-wrapper">
        <table class="timetable">
            <thead>
                <tr>
                    <th style="width: 80px;">时间</th>
                    {% for table in tables %}
                    <th>
                        {{ table.display_label }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <!-- 第一列：时间轴列 -->
                    <td class="time-col">
                        {% for slot in time_slots %}
                        <div class="time-slot-marker">
                            <span class="time-label">{{ slot.label }}</span>
                        </div>
                        {% endfor %}
                    </td>

                    <!-- 后续列：每个桌子一列 -->
                    {% for table in tables %}
                    <td style="padding: 0; border-right: 1px solid #eee; vertical-align: top;">
                        <div class="table-col-content">
                            {% with table_bookings=bookings_by_table|get_item:table.id %}
                                {% for booking in table_bookings %}
                                <div class="booking-block"
                                     style="top:{{ booking|get_top_offset:timetable_start_datetime }}px;height:{{ booking|get_height_px:timetable_start_datetime }}px;"
                                     title="发起人: {{ booking.creator.display_name|default:booking.creator.username }}&#10;时间: {{ booking.start_time|time:'H:i' }} - {{ booking.end_time|time:'H:i' }}">

                                    <strong>{{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}</strong><br>
                                    <span>{{ booking.creator.display_name|default:booking.creator.username }}</span><br>
                                    <small>
                                        半庄数：{{ booking.num_games|default:"-" }}
                                    </small>
                                </div>
                                {% endfor %}
                            {% endwith %}
                        </div>
                    </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>
    </div>

    <div class="timetable-mobile">
        {% for table in tables %}
            <div class="mobile-table-card">
                <div class="mobile-table-head">{{ table.display_label }}</div>
                {% with table_bookings=bookings_by_table|get_item:table.id %}
                    {% if table_bookings %}
                        {% for booking in table_bookings %}
                            <div class="mobile-booking">
                                <strong>{{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}</strong>
                                <div>发起人：{{ booking.creator.display_name|default:booking.creator.username }}</div>
                                <div>半庄数：{{ booking.num_games|default:"-" }}</div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-booking">暂无预约</div>
                    {% endif %}
                {% endwith %}
            </div>
        {% endfor %}
    </div>
</div>

<script>
    // 自动滚动到当前时间附近
    document.addEventListener('DOMContentLoaded', function() {
        const timetableWrapper = document.querySelector('.timetable-wrapper');
        if (timetableWrapper) {
            // 获取视图开始的精确小时和分钟
            const timetableStartString = "{{ timetable_start_datetime|date:'Y/m/d H:i:s' }}";
            const timetableStartDate = new Date(timetableStartString.replace(/-/g, '/')); // 兼容Safari
            const timetableStartMinuteOfToday = (timetableStartDate.getHours() * 60) + timetableStartDate.getMinutes();

            // 获取当前时间的小时和分钟
            const now = new Date();
            const currentMinuteOfToday = (now.getHours() * 60) + now.getMinutes();

            // 计算当前时间相对于时间表起始点的分钟偏移量
            let scrollPositionMinutes = currentMinuteOfToday - timetableStartMinuteOfToday;

            // 转化为像素，并调整滚动位置，使其大致居中
            // 60px = 1小时，即 1px = 1分钟
            const scrollPositionPx = Math.max(0, scrollPositionMinutes);

            // 尝试滚动到当前时间线之前的一部分，使其在视图的中间或靠上位置
            // timetableWrapper.clientHeight / 2 是滚动容器高度的一半
            timetableWrapper.scrollTop = Math.max(0, scrollPositionPx - (timetableWrapper.clientHeight / 3)); 
        }
    });
</script>

{% endblock %}
