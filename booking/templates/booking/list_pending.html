<!-- booking/templates/booking/list_pending.html -->
{% extends 'booking/base.html' %}
{% load booking_extras %} {# 如果这里需要自定义过滤器，请添加 #}

{% block title %}可加入的对局{% endblock %}

{% block content %}
    <style>
        /* 从 base.html 复制过来的通用样式，但为了避免重复和冲突，会做调整，
           理想情况下这些应该放在一个外部CSS文件，这里暂时内联以便快速演示。*/
        
        .table-wrapper {
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 5px;
        }
        .table-container {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden; /* 确保圆角有效 */
        }
        .table-container th, .table-container td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        .table-container th {
            background-color: #e9ecef;
            font-weight: bold;
            color: #495057;
            text-transform: uppercase;
            font-size: 0.95rem;
        }
        .table-container tbody tr:last-child td {
            border-bottom: none;
        }
        .table-container tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* 状态标记 */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
            min-width: 60px; /* 保证最小宽度 */
        }
        .status-PENDING { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; } /* 橙色系 */
        .status-CONFIRMED { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; } /* 绿色系 */
        .status-CANCELED { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; } /* 红色系 */
        
        /* 按钮样式 */
        .action-button {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
        .action-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .user-list {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            display: block;
        }
        @media (max-width: 768px) {
            .table-container {
                border-radius: 0;
                box-shadow: none;
            }
            .table-container table,
            .table-container thead,
            .table-container tbody,
            .table-container th,
            .table-container td,
            .table-container tr {
                display: block;
                width: 100%;
                box-sizing: border-box;
            }
            .table-container tr {
                margin-bottom: 15px;
                border: 1px solid #e9ecef;
                border-radius: 12px;
                padding: 12px;
                background: #fff;
                box-shadow: 0 2px 6px rgba(0,0,0,0.05);
                overflow: hidden;
            }
            .table-container th {
                display: none;
            }
            .table-container td {
                border: none;
                padding: 6px 0;
            }
            .table-container td::before {
                content: attr(data-label);
                font-weight: bold;
                display: block;
                color: #6c757d;
            }
            .action-button {
                width: 100%;
                margin-top: 12px;
            }
        }

    .rule-card {
        background: #f7f9fc;
        border: 1px solid #e1e7f5;
        border-radius: 10px;
        padding: 18px 22px;
        margin: 20px auto 10px;
        max-width: 900px;
    }
    .rule-card h2 {
        margin: 0 0 10px;
        font-size: 1.1rem;
        color: #0d47a1;
    }
    .rule-card ul {
        margin: 0;
        padding-left: 20px;
        color: #495057;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    .rule-card li strong {
        color: #0d47a1;
    }
    .last-hour-alert {
        margin-top: 6px;
        font-size: 0.85rem;
        color: #c92a2a;
        font-weight: 600;
    }
    </style>

    <h1>可加入的对局</h1>
    <div class="rule-card">
        <h2>加入对局须知</h2>
        <ul>
            <li><strong>成行即锁定：</strong>加入后当人数满 4 人即刻匹配成功，若开始时间不足 1 小时将无法再取消。</li>
            <li><strong>请确认时间：</strong>如您已有重叠时段的对局，建议不要重复加入，以免影响队伍安排。</li>
            <li><strong>账号限定：</strong>每个账号仅能为自己加入，如需代朋友加入请使用对应账号。</li>
        </ul>
    </div>

    <div class="table-wrapper">
    <table class="table-container">
        <thead>
            <tr>
                <th>门店</th>
                <th>发起人</th>
                <th>开始时间 - 结束时间</th>
                <th>当前人数 / 满员</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for booking in bookings %}
                {# 根据人数和状态应用不同背景色，方便识别 #}
                {% if booking.participants.count == 4 %}
                    <tr style="background-color: #e9f5e9;"> {# 已满员，提示性浅绿色 #}
                {% elif user in booking.participants.all %}
                    <tr style="background-color: #f0f8ff;"> {# 自己已加入，提示性浅蓝色 #}
                {% else %}
                    <tr>
                {% endif %}
                    <td data-label="门店">{{ booking.store.name }}</td>
                    <td data-label="发起人">{{ booking.creator.display_name|default:booking.creator.username }}</td>
                    <td data-label="时间">
                        <div style="font-weight:600;">{{ booking.start_time|date:"Y-m-d H:i" }}</div>
                        <div style="color:#555;">{{ booking.end_time|date:"Y-m-d H:i" }}</div>
                        <div style="color:#888;font-size:0.85em;">半庄数：{{ booking.num_games|default:"-" }}</div>
                    </td>
                    <td data-label="当前人数">
                        {{ booking.participants.count }} / 4
                        <span class="user-list">
                            ({% for p in booking.participants.all %}{{ p.display_name|default:p.username }}{% if not forloop.last %}, {% endif %}{% endfor %})
                        </span>
                    </td>
                    <td data-label="状态">
                        <span class="status-badge status-{{ booking.status }}">
                            {{ booking.get_status_display }}
                        </span>
                    </td>
                    <td data-label="操作">
                        {% if user.is_authenticated and user not in booking.participants.all and booking.participants.count < 4 %}
                            <form action="{% url 'join_booking' booking.id %}" method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="action-button">加入</button>
                            </form>
                        {% else %}
                            <button class="action-button" disabled>
                                {% if user in booking.participants.all %}已加入
                                {% elif booking.participants.count >= 4 %}已满
                                {% else %}请登录
                                {% endif %}
                            </button>
                        {% endif %}
                        {% if booking.is_last_hour %}
                            <div class="last-hour-alert">⚠️ 开始时间在 1 小时内，匹配成功后无法取消。</div>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; color: #6c757d;">
                        当前没有等待凑桌的对局。
                        {% if user.is_authenticated %}
                            <br>您可以去 <a href="{% url 'store_status' %}" style="color:#007bff;">门店首页</a> 发起新的对局!
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
{% endblock %}
